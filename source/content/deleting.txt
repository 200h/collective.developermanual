===========
Deleting
===========

.. admonition:: Description

        Deleting content items in Plone programmatically.
        How link integrity checks works and how to avoid it.

.. contents :: :local:

Introduction
------------

This document tells how to programmatically delete objects in Plone.

Deleting content by id
----------------------

Deleting content objects is done by IObjectManager.

`IObjectManager definition <http://svn.zope.org/Zope/trunk/src/OFS/interfaces.py?rev=96262&view=auto>`_.

Example::

    # manage_delObjects takes list of ids as an argument
    folder.manage_delObjects(["list", "of", "ids", "to", "delete"])

Or::

    parent = context.aq_parent
    parent.manage_delObjects([context.getId()])


Deleting all content in a folder
--------------------------------

Little tricky. An example:

.. code-block:: python

	ids = folder.objectIds() # Plone 3 or older
        ids = folder.keys()      # Plone 4 or newer
	
    if len(ids) > 0:
        # manage_delObject will mutate the list
        # so we cannot give it tuple returned by objectIds()
        ids = list(ids)
        folder.manage_delObjects(ids)

Bypassing link integrity check
-------------------------------

If link integrity check is on in the site setup, you cannot
delete objects which themselves are link targets or their children 
are link targets.

Instead, a LinkIntegrityException is raised. The LinkIntegrityException
constains information about objects referring to the content
which is not allowed to delete.

``plone.app.linkintegrity.browser.remote`` module contains
code which allows you to delete the object in any case. 
It catches the exception, modifies the HTTP request
to contain a marker interface allowing delete to happen
and then replays the transaction.

In the case the link integrity check fails for manage_delObjects(),
you will be shown a confirmation dialog. The orignal request payload
gots pickled and is stored in HTML form as an encoded.

When the user presses confirm, the orignal request gets unpickled
from HTTP POST payload. Then the view modifies Zope publisher 
so that it will play the orignal unpickled HTTP POST with the marker interface
"Do not care about link integrity breaches" turned on.
    
Fail safe deleting
-------------------

Sometimes object delete might not be possible, because deletion dispatches
events which might raise exception due to bad broken objects or badly behaving code.

`OFS.ObjectManager <http://svn.zope.org/Zope/trunk/src/OFS/ObjectManager.py?rev=115507&view=auto>`_ which is base class for Zope folders, provides internal method to delete 
objects from folder without firing any events::

        site._delObject("broken-folder", suppress_events=True)
        
