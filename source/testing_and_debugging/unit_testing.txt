=================
 Unit testing
=================

Unit tests are automated tests created by developer to ensure that the add-on product is
intact in the current product configuration. Unit tests are regression tests and
are designed to catch broken functionality over the code evolution.

`Plone unit testing tutorial <http://plone.org/documentation/tutorial/richdocument/unit-testing>`_.

Running unit tests
-------------------

For Plone and all registered add-ons - useful to check whether you have a good component set::

    bin/instance test

For one package::

    bin/instance test -s package.subpackage

For one test case::

    bin/instance test -s package.subpackage -t TestCaseClassName

.. warning::

    Test runner does not give an error if you supply invalid package and test case name.
    Instead it just simply doesn't execute tests.

Creating tests
--------------

* http://pypi.python.org/pypi/Products.PloneTestCase

Unit tests and skin data
------------------------

If your test code modifies skin registries you need to force skin data reload.

Example (self = unit test)::

	self._refreshSkinData()


Running add-on installers and extensions profiles for unit tests
-----------------------------------------------------------------

By default, no add-on installers or extension profiles are installed.

You need to modify PloneTestCase.setupPloneSite() call in your
base unit tests.

Simple example::

    ptc.setupPloneSite(products=['namespace.yourproduct'])

Complex example::

    ptc.setupPloneSite(products=['harvinaiset.app', 'TickingMachine'], extension_profiles=["harvinaiset.app:tests","harvinaiset.app:default"])

Installers may fail without interrupting the test run. Monitor Zope start up messages. If you get error like::

    Installing gomobiletheme.basic ... NOT FOUND

You might be missing this from your configure.zcml::

  <five:registerPackage package="." initialize=".initialize" />

Setting log level in unit tests
-------------------------------

Many components use debug output level and unit testing default output level is info.
Import messages may go unnoticed during the unit test development.

Add this to your unit test code::

    def enableDebugLog(self):
        """ Enable context.plone_log() output from Python scripts """
        import sys, logging
        from Products.CMFPlone.log import logger
        logger.root.setLevel(logging.DEBUG)
        logger.root.addHandler(logging.StreamHandler(sys.stdout))

HTTP request
------------

Zope unit tests have faux HTTPRequest object set up.

You can access it::

	self.portal.REQUEST # Faux HTTPRequest object
	

Unit testing and Zope component architecture
--------------------------------------------

Global site manager doesn't behave properly in the unit tests.

See discussion: http://n2.nabble.com/PTC-global-components-bug--tp3413057p3413057.html

ZCML
----

Below are examples how to run special ZCML snippets for your unit tests.

.. code-block:: python

	import unittest

    from base import PaymentProcessorTestCase


    from Products.Five import zcml
    from zope.configuration.exceptions import ConfigurationError


    from getpaid.paymentprocessors.registry import paymentProcessorRegistry
    configure_zcml = '''
    <configure
        xmlns="http://namespaces.zope.org/zope"
        xmlns:five="http://namespaces.zope.org/five"
        xmlns:paymentprocessors="http://namespaces.plonegetpaid.com/paymentprocessors"
        i18n_domain="foo">


        <paymentprocessors:registerProcessor
           name="dummy"
           processor="getpaid.paymentprocessors.tests.dummies.DummyProcessor"
           selection_view="getpaid.paymentprocessors.tests.dummies.DummyButton"
           thank_you_view="getpaid.paymentprocessors.tests.dummies.DummyThankYou"
           />

    </configure>'''


    bad_processor_zcml = '''
    <configure
        xmlns="http://namespaces.zope.org/zope"
        xmlns:five="http://namespaces.zope.org/five"
        xmlns:paymentprocessors="http://namespaces.plonegetpaid.com/paymentprocessors"
        i18n_domain="foo">


        <paymentprocessors:registerProcessor
           name="dummy"
           selection_view="getpaid.paymentprocessors.tests.dummies.DummyButton"
           thank_you_view="getpaid.paymentprocessors.tests.dummies.DummyThankYou"
           />


    </configure>'''




    class TestZCML(PaymentProcessorTestCase):
        """ Test ZCML directives """


        def test_register(self):
            """ Check that ZCML entry gets added to our processor registry """
            zcml.load_string(configure_zcml)


            # See that our processor got registered
            self.assertEqual(len(papaymentProcessorRegistryistry.items()), 1)


        def test_bad_processor(self):
            """ Check that ZCML entry which has bad processor declaration is caught """


            try:
                zcml.load_string(bad_processor_zcml)
                raise AssertionError("Should not be never reached")
            except ConfigurationError, e:
                pass