============
Exceptions
============

.. admonition:: Description

        Common exception traceback patterns developers might encounter with Plone.

List of common developer errors you might encounter and solutions for them.

.. contents :: :local:

AttributeError: 'str' object has no attribute 'other' (Mixed zope.viewpagetemplate and Five.viewpagetemplate)
--------------------------------------------------------------------------------------------------------------

Example traceback::

      Module zope.tales.tales, line 696, in evaluate
       - URL: /home/moo/sits/src/plone.z3cform/plone/z3cform/crud/crud-master.pt
       - Line 17, Column 2
       - Expression: <PathExpr standard:u'form/render'>
       - Names:
          {'args': (),
           'context': <SitsPatient at /folder_sits/sitsngta/intranet/sitsdatabase/sitscountry_TE/sitshospital_TES/sitspatient.TETES2009062217>,
           'default': <object object at 0xb7d76538>,
           'loop': {},
           'nothing': None,
           'options': {},
           'repeat': {},
           'request': <HTTPRequest, URL=http://localhost:9000/folder_sits/sitsngta/intranet/sitsdatabase/sitscountry_TE/sitshospital_TES/sitspatient.TETES2009062217/@@ar>,
           'template': <zope.app.pagetemplate.viewpagetemplatefile.ViewPageTemplateFile object at 0xc6e552c>,
           'usage': <zope.pagetemplate.pagetemplate.TemplateUsage object at 0xf7fb78c>,
           'view': <Products.SitsPatient.browser.ar.ARCrudForm object at 0xf928ccc>,
           'views': <zope.app.pagetemplate.viewpagetemplatefile.ViewMapper object at 0xf7b4a0c>}
      Module Products.PTProfiler.ProfilerPatch, line 32, in __patched_call__
      Module zope.tales.expressions, line 217, in __call__
      Module zope.tales.expressions, line 211, in _eval
      Module z3c.form.form, line 143, in render
      Module Shared.DC.Scripts.Bindings, line 313, in __call__
      Module Shared.DC.Scripts.Bindings, line 348, in _bindAndExec
      Module Shared.DC.Scripts.Bindings, line 1, in ?
      Module Shared.DC.Scripts.Bindings, line 293, in _getTraverseSubpath
    AttributeError: 'str' object has no attribute 'other'

Five ViewPageTemplate class file is slightly different than Zope 3's normal ViewPageTemplate file.
In this case Five ViewPageTemplate was used, when Zope 3's normal ViewPageTemplate was expected.

Another reason is that acquisition chain is not properly set-up in your custom views.

Iteration over non-sequence in _normalizeargs
----------------------------------------------

The following log trace will appear when you try to render
the site, but you can access ZMI normally::

    2009-09-23 20:47:18 WARNING OFS.Uninstalled Could not import class 'IPloneCommentsLayer' from module 'quintagroup.plonecomments.interfaces'
    2009-09-23 20:47:18 ERROR Zope.SiteErrorLog 1253728038.160.534632167217 http://localhost:9444/XXX
    Traceback (innermost last):
      Module plone.postpublicationhook.hook, line 65, in publish
      Module ZPublisher.BaseRequest, line 424, in traverse
      Module ZPublisher.BeforeTraverse, line 99, in __call__
      Module Products.CMFCore.PortalObject, line 94, in __before_publishing_traverse__
      Module zope.event, line 23, in notify
      Module zope.component.event, line 26, in dispatch
      Module zope.component._api, line 130, in subscribers
      Module zope.component.registry, line 290, in subscribers
      Module zope.interface.adapter, line 535, in subscribers
      Module zope.component.event, line 33, in objectEventNotify
      Module zope.component._api, line 130, in subscribers
      Module zope.component.registry, line 290, in subscribers
      Module zope.interface.adapter, line 535, in subscribers
      Module plone.browserlayer.layer, line 18, in mark_layer
      Module zope.interface.declarations, line 848, in directlyProvides
      Module zope.interface.declarations, line 1371, in _normalizeargs
      Module zope.interface.declarations, line 1370, in _normalizeargs
    TypeError: iteration over non-sequence
    2009-09-23 20:47:18 ERROR root Exception while rendering an error message
    Traceback (most recent call last):
      File "/home/moo/XXX/parts/zope2/lib/python/OFS/SimpleItem.py", line 227, in raise_standardErrorMessage
        v = s(**kwargs)
      File "/home/moo/workspace2/collective.skinny/collective/skinny/patch.py", line 8, in standard_error_message
        return self.restrictedTraverse('@@404.html')()
      File "/home/moo/workspace2/collective.skinny/collective/skinny/fourohfour.py", line 22, in __call__
        return skins.plone_templates.standard_error_message.__of__(
      File "/home/moo/XXX/eggs/Products.CMFCore-2.1.2-py2.4.egg/Products/CMFCore/FSPythonScript.py", line 140, in __call__
        return Script.__call__(self, *args, **kw)
      File "/home/moo/XXX/parts/zope2/lib/python/Shared/DC/Scripts/Bindings.py", line 313, in __call__
        return self._bindAndExec(args, kw, None)
      File "/home/moo/XXX/parts/zope2/lib/python/Shared/DC/Scripts/Bindings.py", line 350, in _bindAndExec
        return self._exec(bound_data, args, kw)
      File "/home/moo/XXX/eggs/Products.CMFCore-2.1.2-py2.4.egg/Products/CMFCore/FSPythonScript.py", line 196, in _exec
        result = f(*args, **kw)
      File "Script (Python)", line 27, in standard_error_message
    AttributeError: default_error_message

This usually means that you have copied Data.fs from another
system, but you do not have identical add-on product configuration
installed.

`For more info see this error reference on plone.org <http://plone.org/documentation/error/typeerror-iteration-over-non-sequence>`_.

TraversalError with lots of tuples and lists (METAL problem)
------------------------------------------------------------

Exception::

      File "/home/moo/saariselka/parts/zope2/lib/python/zope/tales/expressions.py", line 217, in __call__
        return self._eval(econtext)
      File "/home/moo/saariselka/parts/zope2/lib/python/Products/PageTemplates/Expressions.py", line 155, in _eval
        ob = self._subexprs[-1](econtext)
      File "/home/moo/saariselka/parts/zope2/lib/python/zope/tales/expressions.py", line 124, in _eval
        ob = self._traverser(ob, element, econtext)
      File "/home/moo/saariselka/parts/zope2/lib/python/Products/PageTemplates/Expressions.py", line 85, in boboAwareZopeTraverse
        request=request)
      File "/home/moo/saariselka/parts/zope2/lib/python/zope/traversing/adapters.py", line 164, in traversePathElement
        return traversable.traverse(nm, further_path)
       - __traceback_info__: ({u'main': [('version', '1.6'), ('mode', 'html'), ('setPosition', (7, 0)), ('setSourceFile', 'file:/home/moo/workspace2/collective.skinny/collective/skinny/skins/skinny_faux_layer/main_template.pt'), ('beginScope', {u'define-macro': u'main'}), ('optTag', (u'metal:main-macro', None, 'metal', 0, [('startTag', (u'metal:main-macro', [(u'define-macro', u'main', 'metal')]))], [('rawtextColumn', (u'\n\t', 1)), ('setPosition', (8, 1)), ('defineSlot', (u'main', [('beginScope', {u'define-slot': u'main'}), ('optTag', (u'metal:main-slot', None, 'metal', 0, [('startTag', (u'metal:main-slot', [(u'define-slot', u'main', 'metal')]))], [('rawtextColumn', (u'\n\t', 1))])), ('endScope', ())])), ('setPosition', (9, 1)), ('setSourceFile', 'file:/home/moo/workspace2/collective.skinny/collective/skinny/skins/skinny_faux_layer/main_template.pt'), ('rawtextColumn', (u'\n', 0))])), ('endScope', ())]}, 'master')
      File "/home/moo/saariselka/parts/zope2/lib/python/zope/traversing/adapters.py", line 52, in traverse
        raise TraversalError(subject, name)
       - __traceback_info__: ({u'main': [('version', '1.6'), ('mode', 'html'), ('setPosition', (7, 0)), ('setSourceFile', 'file:/home/moo/workspace2/collective.skinny/collective/skinny/skins/skinny_faux_layer/main_template.pt'), ('beginScope', {u'define-macro': u'main'}), ('optTag', (u'metal:main-macro', None, 'metal', 0, [('startTag', (u'metal:main-macro', [(u'define-macro', u'main', 'metal')]))], [('rawtextColumn', (u'\n\t', 1)), ('setPosition', (8, 1)), ('defineSlot', (u'main', [('beginScope', {u'define-slot': u'main'}), ('optTag', (u'metal:main-slot', None, 'metal', 0, [('startTag', (u'metal:main-slot', [(u'define-slot', u'main', 'metal')]))], [('rawtextColumn', (u'\n\t', 1))])), ('endScope', ())])), ('setPosition', (9, 1)), ('setSourceFile', 'file:/home/moo/workspace2/collective.skinny/collective/skinny/skins/skinny_faux_layer/main_template.pt'), ('rawtextColumn', (u'\n', 0))])), ('endScope', ())]}, 'master', [])
    TraversalError: ({u'main': [('version', '1.6'), ('mode', 'html'), ('setPosition', (7, 0)), ('setSourceFile', 'file:/home/moo/workspace2/collective.skinny/collective/skinny/skins/skinny_faux_layer/main_template.pt'), ('beginScope', {u'define-macro': u'main'}), ('optTag', (u'metal:main-macro', None, 'metal', 0, [('startTag', (u'metal:main-macro', [(u'define-macro', u'main', 'metal')]))], [('rawtextColumn', (u'\n\t', 1)), ('setPosition', (8, 1)), ('defineSlot', (u'main', [('beginScope', {u'define-slot': u'main'}), ('optTag', (u'metal:main-slot', None, 'metal', 0, [('startTag', (u'metal:main-slot', [(u'define-slot', u'main', 'metal')]))], [('rawtextColumn', (u'\n\t', 1))])), ('endScope', ())])), ('setPosition', (9, 1)), ('setSourceFile', 'file:/home/moo/workspace2/collective.skinny/collective/skinny/skins/skinny_faux_layer/main_template.pt'), ('rawtextColumn', (u'\n', 0))])), ('endScope', ())]}, 'master') (Also, the following error occurred while attempting to render the standard error message, please see the event log for full details: ({u'main': [('version', '1.6'), ('mode', 'html'), ('setPosition', (7, 0)), ('setSourceFile', 'file:/home/moo/workspace2/collective.skinny/collective/skinny/skins/skinny_faux_layer/main_template.pt'), ('beginScope', {u'define-macro': u'main'}), ('optTag', (u'metal:main-macro', None, 'metal', 0, [('startTag', (u'metal:main-macro', [(u'define-macro', u'main', 'metal')]))], [('rawtextColumn', (u'\n\t', 1)), ('setPosition', (8, 1)), ('defineSlot', (u'main', [('beginScope', {u'define-slot': u'main'}), ('optTag', (u'metal:main-slot', None, 'metal', 0, [('startTag', (u'metal:main-slot', [(u'define-slot', u'main', 'metal')]))], [('rawtextColumn', (u'\n\t', 1))])), ('endScope', ())])), ('setPosition', (9, 1)), ('setSourceFile', 'file:/home/moo/workspace2/collective.skinny/collective/skinny/skins/skinny_faux_layer/main_template.pt'), ('rawtextColumn', (u'\n', 0))])), ('endScope', ())]}, 'master'))

Some template tries to call macro inside another template and the macro is not defined in the target template.

AttributeError in setRoles due to workflow state transition
-----------------------------------------------------------

Example::

    Traceback (innermost last):
    Module ZPublisher.Publish, line 115, in publish
    Module ZPublisher.mapply, line 88, in mapply
    Module ZPublisher.Publish, line 41, in call_object
    Module Products.CMFPlone.FactoryTool, line 361, in __call__
    Module Products.CMFPlone.FactoryTool, line 147, in __getitem__
    Module Products.CMFPlone.PloneFolder, line 406, in invokeFactory
    Module Products.CMFCore.TypesTool, line 934, in constructContent
    Module Products.CMFCore.TypesTool, line 345, in constructInstance
    Module Products.CMFCore.TypesTool, line 357, in _finishConstruction
    Module Products.CMFCore.CMFCatalogAware, line 145, in notifyWorkflowCreated
    Module Products.CMFCore.WorkflowTool, line 355, in notifyCreated
    Module Products.DCWorkflow.DCWorkflow, line 392, in notifyCreated
    Module Products.DCWorkflow.DCWorkflow, line 476, in _changeStateOf
    Module Products.DCWorkflow.DCWorkflow, line 571, in _executeTransition
    Module Products.DCWorkflow.DCWorkflow, line 435, in updateRoleMappingsFor
    Module Products.DCWorkflow.utils, line 60, in modifyRolesForPermission
    Module AccessControl.Permission, line 93, in setRoles
    AttributeError: appname

Possible reasons

#. You are using AnnotationStorage but you forgot to declare atapi.ATFieldProperty in your class body

#. You are inhering schema in Archetypes, but you do not inherit the class itself


Add-on installer error: too many values to unpack
--------------------------------------------------

An exception prevents running a quick installer.

Example::

      Module ZPublisher.Publish, line 119, in publish
      Module ZPublisher.mapply, line 88, in mapply
      Module ZPublisher.Publish, line 42, in call_object
      Module Products.CMFQuickInstallerTool.QuickInstallerTool, line 589, in installProducts
      Module Products.CMFQuickInstallerTool.QuickInstallerTool, line 475, in installProduct
       - __traceback_info__: ('gomobile.mobile',)
      Module Products.CMFQuickInstallerTool.QuickInstallerTool, line 396, in snapshotPortal
      Module five.localsitemanager.registry, line 194, in registeredUtilities
      Module zope.component.registry, line 127, in registeredUtilities
    ValueError: too many values to unpack

Reason:

You have run Data.fs with zope.component 3.5.1, but later downgraded / moved Data.fs.
Pin zope.component to 3.5.1.

`See discussion <http://plone.org/support/forums/general#nabble-td3257712%7Ca3257712>`_.

Add-on installer error: This object was originally created by a product that is no longer installed
---------------------------------------------------------------------------------------------------

Example::

    2009-10-18 13:11:20 ERROR Zope.SiteErrorLog 1255860680.760.514176531634 http://localhost:8080/twinapex/portal_quickinstaller/installProducts
    Traceback (innermost last):
      Module ZPublisher.Publish, line 125, in publish
      Module Zope2.App.startup, line 238, in commit
      Module transaction._manager, line 93, in commit
      Module transaction._transaction, line 325, in commit
      Module transaction._transaction, line 424, in _commitResources
      Module ZODB.Connection, line 541, in commit
      Module ZODB.Connection, line 586, in _commit
      Module ZODB.Connection, line 620, in _store_objects
      Module ZODB.serialize, line 407, in serialize
      Module OFS.Uninstalled, line 40, in __getstate__
    SystemError: This object was originally created by a product that
                is no longer installed.  It cannot be updated.
                (<Salt at broken>)

Data.fs contains objects for which the code is not present.
You have probably moved Data.fs or edited buildout.cfg.

Check that eggs and zcml contain all necessary products in buildout.cfg.

Discussion

* http://plone.org/support/forums/general#nabble-td3523234

* http://article.gmane.org/gmane.comp.web.zope.plone.setup/3232


z3c.form based form updateWidgets() raises ComponentLookupError
---------------------------------------------------------------

Example::

    Error in test test_render_form (gomobile.convergence.tests.test_mobile_overrides.TestMobileOverrides)
    Traceback (most recent call last):
      File "/Users/moo/twinapex/twinapex/parts/zope2/lib/python/Testing/ZopeTestCase/profiler.py", line 98, in __call__
        testMethod()
      File "/Users/moo/twinapex/twinapex/src/gomobile.convergence/gomobile/convergence/tests/test_mobile_overrides.py", line 65, in test_render_form
        result()
      File "/Users/moo/twinapex/twinapex/eggs/z3c.form-1.9.0-py2.4.egg/z3c/form/form.py", line 189, in __call__
        self.update()
      File "/Users/moo/twinapex/twinapex/eggs/z3c.form-1.9.0-py2.4.egg/z3c/form/form.py", line 184, in update
        super(Form, self).update()
      File "/Users/moo/twinapex/twinapex/eggs/z3c.form-1.9.0-py2.4.egg/z3c/form/form.py", line 134, in update
        self.updateWidgets()
      File "/Users/moo/twinapex/twinapex/eggs/z3c.form-1.9.0-py2.4.egg/z3c/form/form.py", line 120, in updateWidgets
        self.widgets = zope.component.getMultiAdapter(
      File "/Users/moo/twinapex/twinapex/eggs/zope.component-3.5.1-py2.4.egg/zope/component/_api.py", line 104, in getMultiAdapter
        raise ComponentLookupError(objects, interface, name)
    ComponentLookupError: ((<Products.Five.metaclass.documentoverriderform object at 0x711c6f0>, <HTTPRequest, URL=http://nohost>, <ATDocument at /plone/doc>), <InterfaceClass z3c.form.interfaces.IWidgets>, u'')

Reason: To use z3c.form based forms z3c.form.interfaces.IFormRequest must be enabled for HTTP request
object to make form layer adaptions work.

How to fix:

* Wrap views with plone.z3cform.layour.wrap_form

NotFound error (Page not found) when accessing @@manage-portlets
--------------------------------------------------------------------

If you get *Page not found* error when accessing @@manage-portlets the first thing
you need to do is to enable logging of NotFound exceptions in ZMI in error_log.

After that reload @@manage-portlets.

When you try to access @@manage-portlets an exception a NotFound exception is raised::

    2009-11-09 12:56:13 ERROR Zope.SiteErrorLog 1257764173.180.738005333766 http://localhost:8080/saariselka/@@manage-portlets
    Traceback (innermost last):
      Module ZPublisher.Publish, line 119, in publish
        Module Products.PageTemplates.Expressions, line 223, in evaluateStructure
        ...
      Module zope.tales.tales, line 696, in evaluate
       - URL: file:/Users/moo/workspace/plonetheme.saariselka/plonetheme/saariselka/skins/plonetheme_saariselka_custom_templates/main_template.pt
       - Line 92, Column 18
       - Expression: <StringExpr u'plone.leftcolumn'>
       - Names:
          {'container': <PloneSite at /saariselka>,
           'context': <PloneSite at /saariselka>,
           'default': <object object at 0x194520>,
           'here': <PloneSite at /saariselka>,
           'loop': {},
           'nothing': None,
           'options': {'args': (<Products.Five.metaclass.SimpleViewClass from /Users/moo/saariselka/eggs/plone.app.portlets-1.2-py2.4.egg/plone/app/portlets/browser/templates/manage-contextual.pt object at 0x67e43b0>,)},
           'repeat': <Products.PageTemplates.Expressions.SafeMapping object at 0x73b59b8>,
           'request': <HTTPRequest, URL=http://localhost:8080/saariselka/@@manage-portlets>,
           'root': <Application at >,
           'template': <ImplicitAcquirerWrapper object at 0x73b29f0>,
           'traverse_subpath': [],
           'user': <PropertiedUser 'admin'>,
           'view': <Products.Five.metaclass.SimpleViewClass from /Users/moo/saariselka/eggs/plone.app.portlets-1.2-py2.4.egg/plone/app/portlets/browser/templates/manage-contextual.pt object at 0x67e43b0>,
           'views': <zope.app.pagetemplate.viewpagetemplatefile.ViewMapper object at 0x73b23d0>}
      Module Products.Five.browser.providerexpression, line 37, in __call__
      ...
      Module zope.tales.tales, line 696, in evaluate
       - URL: index
       - Line 18, Column 12
       - Expression: <PathExpr standard:'view/addable_portlets'>
       - Names:
          {'container': <PloneSite at /saariselka>,
           'context': <PloneSite at /saariselka>,
           'default': <object object at 0x194520>,
           'here': <PloneSite at /saariselka>,
           'loop': {},
           'nothing': None,
           'options': {'args': ()},
           'repeat': <Products.PageTemplates.Expressions.SafeMapping object at 0x7941be8>,
           'request': <HTTPRequest, URL=http://localhost:8080/saariselka/@@manage-portlets>,
           'root': <Application at >,
           'template': <ImplicitAcquirerWrapper object at 0x78be050>,
           'traverse_subpath': [],
           'user': <PropertiedUser 'admin'>,
           'view': <plone.app.portlets.browser.editmanager.ContextualEditPortletManagerRenderer object at 0x789eb90>,
           'views': <zope.app.pagetemplate.viewpagetemplatefile.ViewMapper object at 0x790a870>}
      Module zope.tales.expressions, line 217, in __call__
      Module Products.PageTemplates.Expressions, line 163, in _eval
      Module Products.PageTemplates.Expressions, line 125, in render
      Module plone.app.portlets.browser.editmanager, line 154, in addable_portlets
      Module plone.app.portlets.browser.editmanager, line 149, in check_permission
      Module OFS.Traversable, line 301, in restrictedTraverse
      Module OFS.Traversable, line 284, in unrestrictedTraverse
       - __traceback_info__: ([], 'collective.easytemplate.TemplatedPortlet')
    NotFound: collective.easytemplate.TemplatedPortlet

This usually means that your site has an portlet assignment which code is not present anymore.

In this case you can see that portlet type "collective.easytemplate.TemplatedPortlet" is missing.

Ä Check that you include the corresponding product (collective.easytemplate) in eggs= section in buildout.cfg

* Reinstall removed egg which has the code for the portlet

* Check that you include the corresponding product (collective.easytemplate) in zcml= section in buildout.cfg

* Make sure that portlet name is the same in ZCML and GenericSetup XML

* Make sure you use <include package=".portlets" /> in your code


AttributeError: getPhysicalPath()
---------------------------------- 

::

	  Module zope.tal.talinterpreter, line 408, in do_startTag
	  Module zope.tal.talinterpreter, line 485, in attrAction_tal
	  Module Products.PageTemplates.Expressions, line 230, in evaluateText
	  Module zope.tales.tales, line 696, in evaluate
	   - URL: edit_header
	   - Line 25, Column 14
	   - Expression: <PythonExpr (view.getHeaderDefiner().absolute_url())>
	   - Names:
	      {'container': <Frontpage at /saariselka/matkailijalle/saariselka-1>,
	       'context': <Frontpage at /saariselka/matkailijalle/saariselka-1>,
	       'default': <object object at 0x7fabf9cec1f0>,
	       'here': <Frontpage at /saariselka/matkailijalle/saariselka-1>,
	       'loop': {},
	       'nothing': None,
	       'options': {'args': ()},
	       'repeat': <Products.PageTemplates.Expressions.SafeMapping object at 0xe617d88>,
	       'request': <HTTPRequest, URL=http://localhost:9444/saariselka/matkailijalle/saariselka-1/@@edit_header>,
	       'root': <Application at >,
	       'template': <ImplicitAcquirerWrapper object at 0xe6105d0>,
	       'traverse_subpath': [],
	       'user': <PropertiedUser 'admin'>,
	       'view': <Products.Five.metaclass.EditHeaderBehaviorView object at 0xe51ed10>,
	       'views': <zope.app.pagetemplate.viewpagetemplatefile.ViewMapper object at 0xe610c10>}
	  Module zope.tales.pythonexpr, line 59, in __call__
	   - __traceback_info__: (view.getHeaderDefiner().absolute_url())
	  Module <string>, line 0, in ?
	  Module OFS.Traversable, line 64, in absolute_url
	  Module OFS.Traversable, line 117, in getPhysicalPath
	AttributeError: getPhysicalPath
	
Another possibility::

	AttributeError: absolute_url

This usually means that you should have used context.aq_inner when you have used context.
absolute_url() tries to get the path to the object, but object parent is set to view (context.aq_parent)
instead of real container object (context.aq_inner.aq_parent).

.. warning::
	
	When setting a member attribute in BrowserView, the acquisition parent of objec changes to BrowserView instance.
	All member attributes receive ImplicitAcquisitionWrapper automatically.
	
Demostration
============

We try to set BrowserView member attribute defining_context to be some context object.

	(Pdb) self.defining_context = context
	(Pdb) context.aq_parent
	<PloneSite at /plone>
	(Pdb) self.defining_context.aq_parent
	<Products.Five.metaclass.HeaderAnimationHelper object at 0xadb5750>
	(Pdb) self.defining_context.aq_inner.aq_parent
	<Products.Five.metaclass.HeaderAnimationHelper object at 0xadb5750>
	(Pdb) self.defining_context.aq_parent.aq_parent
	<ATDocument at /plone/doc>
	(Pdb) self.defining_context.aq_parent.aq_parent.aq_inner
	<ATDocument at /plone/doc>
	(Pdb) self.defining_context.aq_parent.aq_parent.aq_parent
	<PloneSite at /plone>

To get the real object (as it was before set was called) you can create a helper getter::

    def getDefiningContext(self):        
        """        
        Un-fuse automatically injected view from the acquisition chain
        
        @return: Real defining context object without bad acquistion 
        """
        if self.defining_context is not None:
            return self.defining_context.aq_parent.aq_inner.aq_parent
        return None

        
RuntimeError: maximum recursion depth exceeded (Archetypes field problem)
--------------------------------------------------------------------------

Example::

           atapi.ImageField( 
                'memberimage', 
                # storage=atapi.AnnotationStorage(), # paster version 
                storage=atapi.AttributeStorage(), # results in "max recursion depth exceeded" error 
                widget=atapi.ImageWidget( 
                    label=_(u"New Field"), 
                    description=_(u"Field description"), 
                ), 
                validators=('isNonEmptyFile'), 
                original_size=(600,600), 
                sizes={ 'mini' : (80,80), 
                        'normal' : (200,200), 
                        'big' : (300,300), 
                        'maxi' : (500,500)}, 
            ), 
        
        
        This results in an exception when I try to access the object: 
        
           - __traceback_info__: ('memberimage', <TTMemberImage at tt_member_image.2010-01-23.8138248069>, {'field': <Field memberimage(image:rw)>}) 
          Module Products.Archetypes.Storage, line 96, in get 
          Module Products.Archetypes.utils, line 808, in shasattr 
          Module Products.Archetypes.fieldproperty, line 101, in __get__ 
          Module Products.Archetypes.Field, line 997, in get 
          Module Products.Archetypes.Field, line 709, in get 
           - __traceback_info__: ('memberimage', <TTMemberImage at tt_member_image.2010-01-23.8138248069>, {'field': <Field memberimage(image:rw)>}) 
        RuntimeError: maximum recursion depth exceeded 
       
Reason: Schema fields using AttributeStorage (usually images, files) **cannot** have ATFieldProperty in the class::

        class Sample(base.ATCTContent):
               
            # This does not work with AttributeStorage
            memberimage = atapi.ATFieldProperty('memberimage')
            
To fix this simply remobe ATFieldProperty() declaration for the problematic field. You cannot 
access the field value anymore by calling *object.memberimage* but you need to call *object.getMemberimage()* instead.
                         
         
Invalid or Duplicate property id
--------------------------------

The following exception may appear during Plone migration to the newer version::

            *   Dry run selected.
            * Starting the migration from version: 3.1.4
            * Attempting to upgrade from: 3.1.4
            * Upgrade aborted
            * Error type: zExceptions.BadRequest
            * Error value: Invalid or duplicate property id
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Plone-3.3-py2.4.egg/Products/CMFPlone/MigrationTool.py",
        line 210, in upgrade newv, msgs = self._upgrade(newv)
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Plone-3.3-py2.4.egg/Products/CMFPlone/MigrationTool.py",
        line 321, in _upgrade res = function(self.aq_parent)
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Plone-3.3-py2.4.egg/Products/CMFPlone/migrations/v3_1/final_three1x.py",
        line 15, in three14_three15 loadMigrationProfile(portal,
        'profile-Products.CMFPlone.migrations:3.1.3-3.1.4')
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Plone-3.3-py2.4.egg/Products/CMFPlone/migrations/migration_util.py",
        line 107, in loadMigrationProfile tool.runAllImportStepsFromProfile(profile,
        purge_old=False)
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Products.GenericSetup-1.4.5-py2.4.egg/Products/GenericSetup/tool.py",
        line 390, in runAllImportStepsFromProfile
        ignore_dependencies=ignore_dependencies)
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Products.GenericSetup-1.4.5-py2.4.egg/Products/GenericSetup/tool.py",
        line 1179, in _runImportStepsFromContext message =
        self._doRunImportStep(step, context)
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Products.GenericSetup-1.4.5-py2.4.egg/Products/GenericSetup/tool.py",
        line 1090, in _doRunImportStep return handler(context)
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Plone-3.3-py2.4.egg/Products/CMFPlone/exportimport/propertiestool.py",
        line 37, in importPloneProperties importer.body = body
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Products.GenericSetup-1.4.5-py2.4.egg/Products/GenericSetup/utils.py",
        line 544, in _importBody self._importNode(dom.documentElement)
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Plone-3.3-py2.4.egg/Products/CMFPlone/exportimport/propertiestool.py",
        line 103, in _importNode self._initObjects(node)
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Plone-3.3-py2.4.egg/Products/CMFPlone/exportimport/propertiestool.py",
        line 154, in _initObjects importer.node = child
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Plone-3.3-py2.4.egg/Products/CMFPlone/exportimport/propertiestool.py",
        line 77, in _importNode self._initProperties(node)
            * File
        "/usr/local/Plone3.2.3/buildout-cache/eggs/Products.GenericSetup-1.4.5-py2.4.egg/Products/GenericSetup/utils.py",
        line 724, in _initProperties obj._setProperty(prop_id, val, prop_type)
            * File
        "/usr/local/Plone3.2.3/Zope-2.10.7-final-py2.4/lib/python/OFS/PropertyManager.py",
        line 186, in _setProperty raise BadRequest, 'Invalid or duplicate property
        id'
            * End of upgrade path, migration has finished
            * The upgrade path did NOT reach current version
            * Migration has failed
            * Dry run selected, transaction aborted
            
It is caused by a property (site setting) which already exists and migration tries to create it.
The usual reason is that one has edited site settings in new Plone version before running the migration.

Try remove violating property ids from the site_properties manually in Zope.

Potential candidates to be removed:

* enable_inline_editing

* lock_on_ttw_edit (boolean)

Potential candidates which need to be added manually:

* redirect_links (boolean) 

More info:

* http://www.mail-archive.com/setup@lists.plone.org/msg03988.html


TraversalError: No traversable adapter found
----------------------------------------------

Traceback (innermost last):

    * Module ZPublisher.Publish, line 202, in publish_module_standard
    * Module Products.LinguaPlone.patches, line 66, in new_publish
    * Module ZPublisher.Publish, line 150, in publish
    * Module Zope2.App.startup, line 221, in zpublisher_exception_hook
    * Module ZPublisher.Publish, line 119, in publish
    * Module ZPublisher.mapply, line 88, in mapply
    * Module ZPublisher.Publish, line 42, in call_object
    * Module Shared.DC.Scripts.Bindings, line 313, in __call__
    * Module Shared.DC.Scripts.Bindings, line 350, in _bindAndExec
    * Module Products.CMFCore.FSPageTemplate, line 216, in _exec
    * Module Products.CMFCore.FSPageTemplate, line 155, in pt_render
    * Module Products.PageTemplates.PageTemplate, line 98, in pt_render
    * Module zope.pagetemplate.pagetemplate, line 117, in pt_render
      Warning: Macro expansion failed
      Warning: zope.traversing.interfaces.TraversalError: ('No traversable adapter found',
 
 
This traceback is followed by long dump of template code internals.
      
Usual cause: Some add-on product fails to initialize.

Start Zope in foreground mode (bin/instance fg) to see which product fails.

ImportError: Inappropriate file type for dynamic loading
---------------------------------------------------------

Exception when starting Zope::

          File "/Users/moo/twinapex/twinapex/parts/zope2/lib/python/ZConfig/datatypes.py", line 398, in get
            t = self.search(name)
          File "/Users/moo/twinapex/twinapex/parts/zope2/lib/python/ZConfig/datatypes.py", line 423, in search
            package = __import__(n, g, g, component)
          File "/Users/moo/twinapex/twinapex/parts/zope2/lib/python/Zope2/Startup/datatypes.py", line 20, in ?
            from ZODB.config import ZODBDatabase
          File "/Users/moo/twinapex/twinapex/eggs/ZODB3-3.8.2-py2.4-macosx-10.6-i386.egg/ZODB/__init__.py", line 20, in ?
            from persistent import TimeStamp
          File "/Users/moo/twinapex/twinapex/eggs/ZODB3-3.8.2-py2.4-macosx-10.6-i386.egg/persistent/__init__.py", line 19, in ?
            from cPersistence import Persistent, GHOST, UPTODATE, CHANGED, STICKY
        ImportError: Inappropriate file type for dynamic loading
        
You probably have files lying over from wrong CPU architecture

* Hand copied eggs between servers

* Migrated OS to new version

* You have several Python interpreters installed and you try to run Zope using 
  the wrong interpreter (the one which the code is not compiled for)

How to solve problem

* Delete /parts and /eggs buildout folders, run bootstrap, run buildout.

BadRequest: The id "xxx" is invalid - it is already in use.
------------------------------------------------------------------

Traceback example::

        ...
        Module Products.CMFFormController.Script, line 145, in __call__
        Module Products.CMFCore.FSPythonScript, line 140, in __call__
        Module Shared.DC.Scripts.Bindings, line 313, in __call__
        Module Shared.DC.Scripts.Bindings, line 350, in _bindAndExec
        Module Products.CMFCore.FSPythonScript, line 196, in _exec
        Module None, line 1, in content_edit
        <FSControllerPythonScript at /xxx/content_edit used for /xxx/sisalto/lomapalvelut/portal_factory/HolidayService/aktiviteetit>
        Line 1
        Module Products.CMFCore.FSPythonScript, line 140, in __call__
        Module Shared.DC.Scripts.Bindings, line 313, in __call__
        Module Shared.DC.Scripts.Bindings, line 350, in _bindAndExec
        Module Products.CMFCore.FSPythonScript, line 196, in _exec
        Module None, line 9, in content_edit_impl
        <FSPythonScript at /xxx/content_edit_impl used for /xxx/sisalto/lomapalvelut/portal_factory/HolidayService/aktiviteetit>
        Line 9
        Module Products.CMFPlone.FactoryTool, line 264, in doCreate
        Module Products.ATContentTypes.lib.constraintypes, line 281, in invokeFactory
        Module Products.CMFCore.PortalFolder, line 315, in invokeFactory
        Module Products.CMFCore.TypesTool, line 716, in constructContent
        Module Products.CMFCore.TypesTool, line 276, in constructInstance
        Module Products.CMFCore.TypesTool, line 450, in _constructInstance
        Module xxx.app.content.holidayservice, line 7, in addHolidayService
        Module OFS.ObjectManager, line 315, in _setObject
        Module Products.CMFCore.PortalFolder, line 333, in _checkId
        Module OFS.ObjectManager, line 102, in checkValidId
        BadRequest: The id "holidayservice.2010-03-18.4474765045" is invalid - it is already in use.
        
TODO: Not really sure why this happens.

Try portal_catalog rebuild as a fix.        

Exception: Type name not specified in createObject
------------------------------------------------------

Example traceback::

        Module ZPublisher.Publish, line 119, in publish
        Module ZPublisher.mapply, line 88, in mapply
        Module ZPublisher.Publish, line 42, in call_object
        Module Products.CMFFormController.FSControllerPythonScript, line 104, in __call__
        Module Products.CMFFormController.Script, line 145, in __call__
        Module Products.CMFCore.FSPythonScript, line 140, in __call__
        Module Shared.DC.Scripts.Bindings, line 313, in __call__
        Module Shared.DC.Scripts.Bindings, line 350, in _bindAndExec
        Module Products.CMFCore.FSPythonScript, line 196, in _exec
        Module None, line 11, in createObject
        <FSControllerPythonScript at /xxx/createObject used for /xxx/sisalto/lomapalvelut>
        Line 11
        Exception: Type name not specified
        
This is TODO

Unauthorized: The object is marked as private 
----------------------------------------------

This error is raised when you try to access view functions or objects
for a view, which you call manually from the code.

Example traceback::

          File "/home/moo/twinapex/parts/zope2/lib/python/zope/tales/expressions.py", line 124, in _eval
            ob = self._traverser(ob, element, econtext)
          File "/home/moo/twinapex/parts/zope2/lib/python/Products/PageTemplates/Expressions.py", line 105, in trustedBoboAwareZopeTraverse
            request=request)
          File "/home/moo/twinapex/parts/zope2/lib/python/zope/traversing/adapters.py", line 164, in traversePathElement
            return traversable.traverse(nm, further_path)
          File "/home/moo/twinapex/parts/zope2/lib/python/zope/traversing/adapters.py", line 44, in traverse
            attr = getattr(subject, name, _marker)
          File "/home/moo/twinapex/parts/zope2/lib/python/Shared/DC/Scripts/Bindings.py", line 184, in __getattr__
            return guarded_getattr(self._wrapped, name, default)
          File "/home/moo/twinapex/parts/zope2/lib/python/AccessControl/ImplPython.py", line 563, in validate
            self._context)
          File "/home/moo/twinapex/parts/zope2/lib/python/AccessControl/ImplPython.py", line 443, in validate
            accessed, container, name, value, context)
          File "/home/moo/twinapex/parts/zope2/lib/python/AccessControl/ImplPython.py", line 808, in raiseVerbose
            raise Unauthorized(text)
        Unauthorized: The object is marked as private.  Access to 'showVideo' of (Products.Five.metaclass.SimpleViewClass from /home/moo/twinapex/src/mfabrik.app/mfabrik/app/browser/campaigntopview.pt object at 0x11003a0c) denied.

View acquisition chain is not properly set up and the security manager cannot traverse acquisition
chain parents to properly determine permissions.

You need to use __of__() method to set-up the acquisition chain for the view::

    def getHeadingView(self):
        """
        Check if we have campaign view avaiable for this content and use it.
        """
        view = queryMultiAdapter((self.context, self.request), name="mfabrik_heading")
        view = view.__of__(self.context) # <---------- here
        return view


ImportError: No module named PIL
---------------------------------

Example::


        Traceback (most recent call last):
          File "/home/moo/isleofback/parts/zope2/lib/python/OFS/Application.py", line 709, in import_product
            product=__import__(pname, global_dict, global_dict, silly)
          File "/home/moo/isleofback/eggs/Products.ATContentTypes-1.3.4-py2.4.egg/Products/ATContentTypes/__init__.py", line 64, in ?
            import Products.ATContentTypes.content
          File "/home/moo/isleofback/eggs/Products.ATContentTypes-1.3.4-py2.4.egg/Products/ATContentTypes/content/__init__.py", line 26, in ?
            import Products.ATContentTypes.content.link
          File "/home/moo/isleofback/eggs/Products.ATContentTypes-1.3.4-py2.4.egg/Products/ATContentTypes/content/link.py", line 39, in ?
            from Products.ATContentTypes.content.base import registerATCT
          File "/home/moo/isleofback/eggs/Products.ATContentTypes-1.3.4-py2.4.egg/Products/ATContentTypes/content/base.py", line 63, in ?
            from Products.CMFPlone.PloneFolder import ReplaceableWrapper
          File "/home/moo/isleofback/eggs/Plone-3.3.5-py2.4.egg/Products/CMFPlone/__init__.py", line 215, in ?
            from browser import ploneview
          File "/home/moo/isleofback/eggs/Plone-3.3.5-py2.4.egg/Products/CMFPlone/browser/ploneview.py", line 12, in ?
            from Products.CMFPlone import utils
          File "/home/moo/isleofback/eggs/Plone-3.3.5-py2.4.egg/Products/CMFPlone/utils.py", line 6, in ?
            from PIL import Image
        ImportError: No module named PIL
        Traceback (most recent call last):
          File "/home/moo/isleofback/bin/idelauncher.py", line 140, in ?
            execfile(ZOPE_RUN)
          File "/home/moo/isleofback/bin/../parts/zope2/lib/python/Zope2/Startup/run.py", line 56, in ?
            run()
          File "/home/moo/isleofback/bin/../parts/zope2/lib/python/Zope2/Startup/run.py", line 21, in run
            starter.prepare()
          File "/home/moo/isleofback/parts/zope2/lib/python/Zope2/Startup/__init__.py", line 102, in prepare
            self.startZope()
          File "/home/moo/isleofback/parts/zope2/lib/python/Zope2/Startup/__init__.py", line 278, in startZope
            Zope2.startup()
          File "/home/moo/isleofback/parts/zope2/lib/python/Zope2/__init__.py", line 47, in startup
            _startup()
          File "/home/moo/isleofback/parts/zope2/lib/python/Zope2/App/startup.py", line 45, in startup
            OFS.Application.import_products()
          File "/home/moo/isleofback/parts/zope2/lib/python/OFS/Application.py", line 686, in import_products
            import_product(product_dir, product_name, raise_exc=debug_mode)
          File "/home/moo/isleofback/parts/zope2/lib/python/OFS/Application.py", line 709, in import_product
            product=__import__(pname, global_dict, global_dict, silly)
          File "/home/moo/isleofback/eggs/Products.ATContentTypes-1.3.4-py2.4.egg/Products/ATContentTypes/__init__.py", line 64, in ?
            import Products.ATContentTypes.content
          File "/home/moo/isleofback/eggs/Products.ATContentTypes-1.3.4-py2.4.egg/Products/ATContentTypes/content/__init__.py", line 26, in ?
            import Products.ATContentTypes.content.link
          File "/home/moo/isleofback/eggs/Products.ATContentTypes-1.3.4-py2.4.egg/Products/ATContentTypes/content/link.py", line 39, in ?
            from Products.ATContentTypes.content.base import registerATCT
          File "/home/moo/isleofback/eggs/Products.ATContentTypes-1.3.4-py2.4.egg/Products/ATContentTypes/content/base.py", line 63, in ?
            from Products.CMFPlone.PloneFolder import ReplaceableWrapper
          File "/home/moo/isleofback/eggs/Plone-3.3.5-py2.4.egg/Products/CMFPlone/__init__.py", line 215, in ?
            from browser import ploneview
          File "/home/moo/isleofback/eggs/Plone-3.3.5-py2.4.egg/Products/CMFPlone/browser/ploneview.py", line 12, in ?
            from Products.CMFPlone import utils
          File "/home/moo/isleofback/eggs/Plone-3.3.5-py2.4.egg/Products/CMFPlone/utils.py", line 6, in ?
            from PIL import Image
        ImportError: No module named PIL
        
Python Imaging Library is not properly installed. The default shipped PIL package is broken. 

Remove all existing PIL eggs from buildout/eggs folder.

Install PIL for your development Python environment::

        easy_install http://dist.repoze.org/PIL-1.1.6.tar.gz


